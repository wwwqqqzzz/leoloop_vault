name: Publish to blog
on:
  push:
    branches: [ main ]
    paths:
      - 'blog/**'
      - 'blog/authors.yml'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Collect markdown from vault
        run: |
          mkdir -p sync_src
          rsync -av --include='*/' --include='*.md' --include='authors.yml' --exclude='*' blog/ sync_src/
      - name: Clone blog repo
        run: |
          git clone --depth=1 "https://x-access-token:${{ secrets.BLOG_REPO_TOKEN }}@github.com/wwwqqqzzz/blog.git" blog_repo
      - name: Prepare branch and copy files
        run: |
          cd blog_repo
          git checkout -B sync/vault origin/main || git checkout -B sync/vault
          rsync -av --delete ../sync_src/ blog/
          git config user.email "2158588419@qq.com"
          git config user.name "wwwqqqzzz-bot"
          if git status --porcelain | grep -q .; then
            git add blog
            git commit -m "chore(posts): sync from vault"
            git push -u origin sync/vault
          else
            echo "No changes"
            exit 0
          fi
      - name: Open PR with automerge
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.BLOG_REPO_TOKEN }}
          title: chore(posts): sync from vault
          body: Automated sync from leoloop_vault
          commit-message: chore(posts): sync from vault
          branch: sync/vault
          base: main
          labels: sync-from-vault
          merge-method: squash
          auto-merge: true